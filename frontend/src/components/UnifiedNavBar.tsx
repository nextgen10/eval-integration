'use client';

import React, { useState } from 'react';
import {
    Box, Button, Container, Typography, useTheme, alpha,
    IconButton, Drawer, List, ListItemButton, ListItemIcon, ListItemText, Divider, useMediaQuery,
} from '@mui/material';
import { Menu as MenuIcon, X } from 'lucide-react';
import { UbsLogoFull } from './UbsLogoFull';
import { BrandPipe } from './BrandPipe';

interface UnifiedNavBarProps {
    title: string;
    items: {
        id: string;
        label: string;
        icon?: React.ReactNode;
        onClick?: () => void;
        active?: boolean;
    }[];
    onLogoClick?: () => void;
    actions?: React.ReactNode;
}

/**
 * UBS-style navigation bar: clean, minimal, professional.
 * Collapses to hamburger drawer on mobile/tablet.
 */
export const UnifiedNavBar: React.FC<UnifiedNavBarProps> = ({
    title,
    items,
    onLogoClick,
    actions
}) => {
    const theme = useTheme();
    const isLight = theme.palette.mode === 'light';
    const isMobile = useMediaQuery(theme.breakpoints.down('md'));
    const [drawerOpen, setDrawerOpen] = useState(false);

    const renderTitle = (titleStr: string) => {
        const parts = titleStr.split(' ');
        const evalIdx = parts.findIndex(p => p.toUpperCase() === 'EVAL');
        const lastWord = parts[parts.length - 1].toUpperCase();
        const titleSx = { fontWeight: 600, letterSpacing: '-0.01em', color: 'text.primary', whiteSpace: 'nowrap', fontSize: { xs: '0.95rem', md: '1.125rem' } };
        const isQualaris = titleStr.toUpperCase() === 'QUALARIS';

        if (isQualaris) {
            return (
                <Typography variant="h6" sx={titleSx}>
                    {titleStr.split('').map((char, idx) => (
                        <React.Fragment key={`${char}-${idx}`}>
                            <Box
                                component="span"
                                sx={{
                                    display: 'inline-block',
                                    color: idx % 2 === 0 ? 'primary.main' : 'text.primary',
                                    '@keyframes qualarisWave': {
                                        '0%, 100%': { transform: 'translateY(0px)', opacity: 0.95 },
                                        '50%': { transform: 'translateY(-1.5px)', opacity: 1 },
                                    },
                                    animation: 'qualarisWave 1.6s ease-in-out infinite',
                                    animationDelay: `${idx * 0.08}s`,
                                }}
                            >
                                {char}
                            </Box>
                            {idx < titleStr.length - 1 && (
                                <Box
                                    component="span"
                                    sx={{
                                        display: 'inline-block',
                                        mx: 0.18,
                                        color: idx % 2 === 0 ? 'text.primary' : 'primary.main',
                                        opacity: 0.85,
                                        fontWeight: 700,
                                    }}
                                >
                                    &middot;
                                </Box>
                            )}
                        </React.Fragment>
                    ))}
                </Typography>
            );
        }

        if (evalIdx >= 0 && evalIdx < parts.length - 1) {
            const mainPart = parts.slice(0, evalIdx).join(' ');
            const redPart = parts.slice(evalIdx).join(' ');
            return (
                <Typography variant="h6" sx={titleSx}>
                    {mainPart}{mainPart ? ' ' : ''}<Box component="span" sx={{ color: 'primary.main' }}>{redPart}</Box>
                </Typography>
            );
        }
        if (parts.length > 1 && (lastWord === 'EVAL' || lastWord === 'DOCS' || lastWord === 'GENERATOR')) {
            const mainPart = parts.slice(0, -1).join(' ');
            return (
                <Typography variant="h6" sx={titleSx}>
                    {mainPart} <Box component="span" sx={{ color: 'primary.main' }}>{lastWord}</Box>
                </Typography>
            );
        }
        return <Typography variant="h6" sx={titleSx}>{titleStr}</Typography>;
    };

    return (
        <>
            <Box
                sx={{
                    position: 'sticky',
                    top: 0,
                    zIndex: 1200,
                    width: '100%',
                    bgcolor: 'background.paper',
                    borderBottom: '1px solid',
                    borderColor: 'divider',
                    ...(isLight && { boxShadow: '0 1px 0 rgba(0,0,0,0.04)' }),
                }}
            >
                <Container maxWidth="xl" sx={{ height: 64, display: 'flex', alignItems: 'center', justifyContent: 'space-between', px: { xs: 2, md: 3 }, position: 'relative' }}>
                    {/* Brand */}
                    <Box sx={{ display: 'flex', alignItems: 'center', zIndex: 1 }}>
                        <Box onClick={onLogoClick} sx={{ display: 'flex', alignItems: 'center', gap: 1.5, cursor: 'pointer' }}>
                            <UbsLogoFull
                                height={isMobile ? 28 : 36}
                                keysColor={isLight ? theme.palette.text.primary : theme.palette.primary.main}
                                wordmarkColor={isLight ? theme.palette.primary.main : '#FFFFFF'}
                            />
                            <BrandPipe />
                            {renderTitle(title)}
                        </Box>
                    </Box>

                    {/* Desktop: centered nav links */}
                    {!isMobile && (
                        <Box sx={{ position: 'absolute', left: '50%', transform: 'translateX(-50%)', display: 'flex', alignItems: 'center', gap: 0.25 }}>
                            {items.map((item) => (
                                <Button
                                    key={item.id}
                                    onClick={item.onClick}
                                    startIcon={item.icon}
                                    variant="text"
                                    sx={{
                                        px: 2, py: 1, borderRadius: 1, fontSize: '0.875rem',
                                        minWidth: 118,
                                        color: item.active ? 'primary.main' : 'text.secondary',
                                        bgcolor: item.active ? (isLight ? '#FFE5E5' : alpha(theme.palette.primary.main, 0.12)) : 'transparent',
                                        fontWeight: 600,
                                        '&:hover': {
                                            color: 'primary.main',
                                            bgcolor: isLight ? 'rgba(208,0,0,0.06)' : alpha(theme.palette.primary.main, 0.08),
                                        },
                                    }}
                                >
                                    {item.label}
                                </Button>
                            ))}
                        </Box>
                    )}

                    {/* Right side */}
                    <Box sx={{ display: 'flex', alignItems: 'center', gap: { xs: 1, md: 2 }, zIndex: 1 }}>
                        {!isMobile && actions}
                        {isMobile && (
                            <IconButton onClick={() => setDrawerOpen(true)} sx={{ color: 'text.primary' }}>
                                <MenuIcon size={22} />
                            </IconButton>
                        )}
                    </Box>
                </Container>
            </Box>

            {/* Mobile drawer */}
            <Drawer
                anchor="right"
                open={drawerOpen && isMobile}
                onClose={() => setDrawerOpen(false)}
                PaperProps={{
                    sx: { width: 280, bgcolor: 'background.paper', pt: 1 },
                }}
            >
                <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', px: 2, py: 1 }}>
                    <Typography variant="subtitle2" fontWeight={700} color="text.secondary">Menu</Typography>
                    <IconButton size="small" onClick={() => setDrawerOpen(false)}>
                        <X size={18} />
                    </IconButton>
                </Box>
                <Divider />
                <List sx={{ px: 1, py: 1 }}>
                    {items.map((item) => (
                        <ListItemButton
                            key={item.id}
                            onClick={() => { item.onClick?.(); setDrawerOpen(false); }}
                            sx={{
                                borderRadius: 2, mb: 0.5,
                                bgcolor: item.active ? alpha(theme.palette.primary.main, 0.08) : 'transparent',
                                color: item.active ? 'primary.main' : 'text.primary',
                                '&:hover': { bgcolor: alpha(theme.palette.primary.main, 0.06) },
                            }}
                        >
                            {item.icon && <ListItemIcon sx={{ minWidth: 36, color: 'inherit' }}>{item.icon}</ListItemIcon>}
                            <ListItemText primary={item.label} primaryTypographyProps={{ fontWeight: item.active ? 700 : 500, fontSize: '0.9rem' }} />
                        </ListItemButton>
                    ))}
                </List>
                <Divider sx={{ my: 1 }} />
                <Box sx={{ px: 2, py: 1, display: 'flex', flexDirection: 'column', gap: 1 }}>
                    {actions}
                </Box>
            </Drawer>
        </>
    );
};
